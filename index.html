<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LibreCall v0.33</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#121212">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <link rel="manifest" id="my-manifest-placeholder">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgZmlsbD0iIzEyMTIxMiIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjI1NiIgcj0iMTgwIiBmaWxsPSIjMDA3YmZmIi8+PHBhdGggZD0iTTI1NiAxNTZsLTQwIDQwIDQwIDQwIDQwLTQwLTQwLTQwem0wIDAgdjgwIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIwIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz48L3N2Zz4=">

    <style>
        /* --- GLOBAL LAYOUT --- */
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding-top: env(safe-area-inset-top); 
            padding-bottom: env(safe-area-inset-bottom);
            box-sizing: border-box;
        }

        /* --- HEADER --- */
        h1 { 
            margin: 20px 0 15px 0; 
            font-weight: 200; 
            letter-spacing: 2px;
            font-size: 2.5rem;
            background: linear-gradient(45deg, #ffffff, #b0b0b0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 4px 12px rgba(0,0,0,0.5);
            text-align: center;
            z-index: 10;
        }
        
        .version-tag {
            font-size: 0.4em;
            vertical-align: baseline;
            opacity: 0.8;           
            letter-spacing: 1px;
            font-weight: 400;     
            margin-left: 10px;
            -webkit-text-fill-color: #888;
            text-shadow: none;
        }

        /* --- VIDEO STAGE (Fullscreen Container) --- */
        .video-stage {
            position: relative;
            width: 95%;
            max-width: 1000px;
            aspect-ratio: 16/9;
            background-color: #000;
            border-radius: 16px;
            border: 1px solid #333;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        /* Fullscreen pseudo-class fix */
        .video-stage:fullscreen {
            width: 100vw;
            height: 100vh;
            max-width: none;
            border-radius: 0;
            border: none;
            margin: 0;
        }
        /* Webkit prefix for Safari/iOS */
        .video-stage:-webkit-full-screen {
            width: 100%;
            height: 100%;
            border-radius: 0;
        }

        /* The Main Video (Background) */
        video.main-view {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            cursor: zoom-in; /* Hint that you can expand */
        }
        /* Change cursor when already fullscreen */
        .video-stage:fullscreen video.main-view { cursor: zoom-out; }

        /* The PiP Video (Corner) */
        video.pip-view {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 25%;
            max-width: 200px;
            aspect-ratio: 16/9;
            border-radius: 12px;
            border: 2px solid rgba(255,255,255,0.3);
            box-shadow: 0 4px 15px rgba(0,0,0,0.6);
            object-fit: cover;
            cursor: pointer;
            z-index: 10;
            transition: transform 0.2s, bottom 0.3s, right 0.3s;
        }
        video.pip-view:hover { transform: scale(1.05); border-color: #fff; }

        /* --- CONTROLS CONTAINER --- */
        .controls {
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 16px;
            width: 95%;
            max-width: 800px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 30px;
        }

        @media (min-width: 768px) {
            .controls {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
            }
        }

        .signaling-col { display: flex; flex-direction: column; gap: 8px; }
        
        /* Labels & Inputs */
        .code-label {
            font-size: 11px; font-weight: 700; color: #888; text-transform: uppercase; letter-spacing: 1px;
        }
        textarea.code-box {
            width: 100%; height: 45px;
            background-color: #2b2b2b; color: #00ff9d;
            border: 1px solid #444; border-radius: 8px;
            font-family: monospace; resize: none;
            font-size: 11px; padding: 8px; box-sizing: border-box;
        }

        /* Chat & Log */
        #chatLog {
            height: 150px;
            background-color: #000;
            border: 1px solid #333;
            border-radius: 8px;
            overflow-y: auto;
            padding: 10px;
            font-family: monospace;
            font-size: 13px;
            margin-bottom: 5px;
        }
        .system-msg { color: #ff4444; font-weight: bold; }
        .user-msg { color: #fff; }
        .my-msg { color: #4caf50; }

        /* Buttons */
        button.std-btn {
            padding: 12px; border: none; border-radius: 8px;
            font-size: 14px; font-weight: 600; color: white;
            cursor: pointer; text-transform: uppercase; width: 100%;
            transition: opacity 0.2s;
        }
        button.std-btn:disabled { background-color: #333 !important; color: #666; cursor: not-allowed; }
        
        button.sub-btn {
            padding: 8px; border: none; border-radius: 6px;
            font-size: 12px; background-color: #444; color: white;
            cursor: pointer; flex: 1;
        }
        button.sub-btn:hover { background-color: #555; }
        
        .btn-group { display: flex; gap: 10px; margin-top: 5px; }
        .btn-blue { background-color: #007bff; }
        .btn-green { background-color: #28a745; }
        .btn-cyan { background-color: #17a2b8; }
        .btn-red { background-color: #dc3545; }
        .btn-grey { background-color: #444; }

        /* Media Buttons */
        .media-bar {
            display: flex; justify-content: center; gap: 15px; margin-top: 10px;
        }
        .icon-btn {
            width: 50px; height: 50px; border-radius: 50%; border: none;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s;
        }
        .icon-btn:hover { transform: scale(1.1); }
        .icon-btn svg { width: 24px; height: 24px; fill: white; }
        .media-off { background-color: #d32f2f; }
        .media-on { background-color: #444; }

        /* Chat Input */
        .chat-input-area { display: flex; gap: 8px; }
        input.chat-input {
            flex-grow: 1; padding: 10px; background: #2b2b2b;
            border: 1px solid #444; color: white; border-radius: 8px; outline: none; font-size: 16px;
        }

        /* --- MOBILE RESPONSIVE TWEAKS --- */
        @media (max-width: 768px) {
            h1 { font-size: 2rem; margin-top: 10px; margin-bottom: 10px; }
            
            .video-stage {
                width: 95%;
                aspect-ratio: 9/16; /* Portrait Mode for Mobile */
                max-height: 65vh;
            }
            
            video.pip-view {
                width: 30%;
                bottom: 15px; right: 15px;
            }

            .controls {
                width: 100%;
                border-radius: 0;
                padding: 15px;
                display: flex; 
            }
        }
    </style>
</head>
<body>

    <script>
        // MANIFEST
        const manifest = {
            "name": "LibreCall",
            "short_name": "LibreCall",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#121212",
            "theme_color": "#121212",
            "orientation": "portrait",
            "icons": [{
                "src": "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgZmlsbD0iIzEyMTIxMiIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjI1NiIgcj0iMTgwIiBmaWxsPSIjMDA3YmZmIi8+PHBhdGggZD0iTTI1NiAxNTZsLTQwIDQwIDQwIDQwIDQwLTQwLTQwLTQwem0wIDAgdjgwIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIwIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz48L3N2Zz4=",
                "sizes": "512x512",
                "type": "image/svg+xml"
            }]
        };
        const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        document.querySelector('#my-manifest-placeholder').setAttribute('href', URL.createObjectURL(blob));
    </script>

    <h1>LibreCall<span class="version-tag">v0.33</span></h1>

    <div class="video-stage" id="videoContainer">
        <video id="remoteVideo" class="main-view" autoplay playsinline onclick="handleVideoClick(this)"></video>
        <video id="localVideo" class="pip-view" autoplay playsinline muted onclick="handleVideoClick(this)"></video>
    </div>

    <div class="controls">
        
        <div class="signaling-col">
            <button id="btnMain" class="std-btn btn-blue" onclick="handleMainButton()">Create Offer</button>
            
            <div class="code-label">Your Code</div>
            <textarea id="localSdp" class="code-box" readonly placeholder="Wait for generation..."></textarea>
            <div class="btn-group">
                <button id="btnCopy" class="sub-btn" onclick="copyToClipboard()" disabled>Copy</button>
                <button class="sub-btn" onclick="clearLocalCode()">Clear</button>
            </div>

            <div class="code-label" style="margin-top: 10px;">Friend's Code</div>
            <textarea id="remoteSdp" class="code-box" placeholder="Paste code here..." oninput="updateUI()"></textarea>
            <div class="btn-group">
                <button id="btnPaste" class="sub-btn" onclick="pasteFromClipboard()">Paste</button>
                <button class="sub-btn" onclick="clearRemoteCode()">Clear</button>
            </div>
        </div>

        <div class="signaling-col">
            <div id="chatLog"></div>
            
            <div class="chat-input-area">
                <input type="text" id="chatInput" class="chat-input" placeholder="Message..." onkeypress="handleEnter(event)" disabled>
                <button id="btnSend" class="std-btn btn-blue" style="width: auto; padding: 0 20px;" onclick="sendMessage()" disabled>></button>
            </div>

            <div class="media-bar">
                <button id="btnVideo" class="icon-btn media-off" onclick="toggleVideo()" title="Camera">
                    <svg viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg>
                </button>
                <button id="btnAudio" class="icon-btn media-off" onclick="toggleAudio()" title="Microphone">
                    <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
                </button>
            </div>
        </div>

    </div>

    <script>
        const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
        const ICONS = {
            videoOn: '<svg viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg>',
            videoOff: '<svg viewBox="0 0 24 24"><path d="M9.56 8l-2-2-4.15-4.15L2 3.27 4.73 6H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.21 0 .39-.08.54-.18L19.73 21l1.27-1.27-11.44-11.73zM16 16.17L5.83 6H16v10.17zM18 7c0-.55-.45-1-1-1h-2.17l2 2V7zm2 8.17V7l-4 3.33V12l2.34 2.34L20 15.17z"/></svg>',
            micOn: '<svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>',
            micOff: '<svg viewBox="0 0 24 24"><path d="M19 11h-1.7c0 .74-.16 1.43-.43 2.05l1.23 1.23c.56-.98.9-2.09.9-3.28zm-4.02.17c0-.06.02-.11.02-.17V5c0-1.66-1.34-3-3-3S9 3.34 9 5v.18l5.98 5.99zM4.27 3L3 4.27l6.01 6.01V11c0 1.66 1.33 3 2.99 3 .22 0 .44-.03.65-.08l2.97 2.97c-.85.35-1.76.57-2.75.57-3.7 0-6.73-2.94-6.88-6.6l-.01.03H4.15c.16 4.61 3.75 8.41 8.35 8.9V21h3v-1.14l4.22 4.23L21 22.73 4.27 3z"/></svg>'
        };

        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const videoContainer = document.getElementById('videoContainer');
        
        const chatLog = document.getElementById('chatLog');
        const localSdpBox = document.getElementById('localSdp');
        const remoteSdpBox = document.getElementById('remoteSdp');
        const chatInput = document.getElementById('chatInput');
        const btnSend = document.getElementById('btnSend');
        const btnMain = document.getElementById('btnMain');
        const btnVideo = document.getElementById('btnVideo');
        const btnAudio = document.getElementById('btnAudio');

        let localStream, peerConnection, dataChannel;
        let isConnected = false;
        let lastProcessedRemoteCode = '';
        let offerGenerated = false;

        // --- NEW: SMART VIDEO CLICK HANDLER ---
        function handleVideoClick(el) {
            // Logic: 
            // 1. If user clicks the PiP (small) -> SWAP videos.
            // 2. If user clicks the Main (big) -> Toggle FULLSCREEN.
            
            if (el.classList.contains('pip-view')) {
                // Perform Swap
                const isLocalPiP = localVideo.classList.contains('pip-view');
                if (isLocalPiP) {
                    // Make Local Main
                    localVideo.className = 'main-view';
                    remoteVideo.className = 'pip-view';
                } else {
                    // Make Remote Main
                    localVideo.className = 'pip-view';
                    remoteVideo.className = 'main-view';
                }
            } else {
                // Toggle Fullscreen on Container
                if (!document.fullscreenElement) {
                    videoContainer.requestFullscreen().catch(err => {
                        log("Error enabling full-screen mode: " + err.message);
                    });
                } else {
                    document.exitFullscreen();
                }
            }
        }

        // --- CORE FUNCTIONS ---
        function log(msg, type='system') {
            const line = document.createElement('div');
            const time = new Date().toLocaleTimeString();
            if (type === 'system') line.className = 'system-msg';
            else if (type === 'me') line.className = 'my-msg';
            else line.className = 'user-msg';
            line.innerText = `[${time}] ${type.toUpperCase()}: ${msg}`;
            chatLog.appendChild(line);
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        async function compress(string) {
            try {
                if (!window.CompressionStream) throw new Error("No Compression");
                const stream = new Blob([string]).stream();
                const compressedReadableStream = stream.pipeThrough(new CompressionStream("gzip"));
                const compressedResponse = await new Response(compressedReadableStream);
                const blob = await compressedResponse.blob();
                const buffer = await blob.arrayBuffer();
                return btoa(String.fromCharCode(...new Uint8Array(buffer)));
            } catch(e) { return btoa(string); }
        }

        async function decompress(base64) {
            const clean = base64.replace(/\s+/g, '').trim();
            if (!clean) throw new Error("Empty");
            try {
                if (!window.DecompressionStream) throw new Error("No Decompression");
                const bin = atob(clean);
                const bytes = Uint8Array.from(bin, c => c.charCodeAt(0));
                const stream = new Blob([bytes]).stream();
                const decomp = stream.pipeThrough(new DecompressionStream("gzip"));
                const resp = await new Response(decomp);
                return await resp.text();
            } catch(e) { return atob(clean); }
        }

        function toggleVideo() {
            if (!localStream) return;
            const track = localStream.getVideoTracks()[0];
            track.enabled = !track.enabled;
            btnVideo.className = track.enabled ? "icon-btn media-on" : "icon-btn media-off";
            btnVideo.innerHTML = track.enabled ? ICONS.videoOn : ICONS.videoOff;
        }

        function toggleAudio() {
            if (!localStream) return;
            const track = localStream.getAudioTracks()[0];
            track.enabled = !track.enabled;
            btnAudio.className = track.enabled ? "icon-btn media-on" : "icon-btn media-off";
            btnAudio.innerHTML = track.enabled ? ICONS.micOn : ICONS.micOff;
        }

        function updateMediaUI() {
            if (localStream) {
                const v = localStream.getVideoTracks()[0].enabled;
                const a = localStream.getAudioTracks()[0].enabled;
                btnVideo.className = v ? "icon-btn media-on" : "icon-btn media-off";
                btnVideo.innerHTML = v ? ICONS.videoOn : ICONS.videoOff;
                btnAudio.className = a ? "icon-btn media-on" : "icon-btn media-off";
                btnAudio.innerHTML = a ? ICONS.micOn : ICONS.micOff;
            }
        }

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localStream = stream;
                
                // Initial: Local is Main, Remote is PiP
                localVideo.srcObject = stream;
                localVideo.className = 'main-view';
                remoteVideo.className = 'pip-view';
                
                // Privacy: Start Muted
                stream.getVideoTracks()[0].enabled = false;
                stream.getAudioTracks()[0].enabled = false;
                updateMediaUI();
                
                log("Devices ready: Camera & Microphone.");
            } catch (err) {
                console.error(err);
                log("Error: Camera access denied.");
            }
        }

        async function finalizeCodeGeneration() {
            if (offerGenerated) return;
            offerGenerated = true;
            let sdp = peerConnection.localDescription.sdp;
            const json = JSON.stringify({ type: peerConnection.localDescription.type, sdp: sdp });
            try {
                const compressed = await compress(json);
                localSdpBox.value = compressed;
                updateUI();
                log("Code generated! Send it to your friend.");
            } catch (e) { log("Error: " + e.message); }
        }

        function createPeerConnection() {
            peerConnection = new RTCPeerConnection(config);
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            peerConnection.ontrack = (event) => {
                remoteVideo.srcObject = event.streams[0];
                // AUTO SWAP on Connect: Remote -> Main, Local -> PiP
                remoteVideo.className = 'main-view';
                localVideo.className = 'pip-view';
            };

            peerConnection.onconnectionstatechange = () => {
                if (peerConnection.connectionState === 'connected') setConnectedState(true);
                else if (peerConnection.connectionState === 'disconnected') setConnectedState(false);
            };

            offerGenerated = false;
            peerConnection.onicecandidate = async (event) => {
                if (event.candidate === null) await finalizeCodeGeneration();
            };
            
            setTimeout(() => {
                if (!offerGenerated && peerConnection.iceGatheringState !== 'complete') finalizeCodeGeneration();
            }, 2000);
        }

        function setupDataChannel(channel) {
            channel.onopen = () => {
                log("Connection established! Happy LibreCall.");
                setConnectedState(true);
            };
            channel.onmessage = (event) => {
                if (event.data === "SYSTEM:DISCONNECT") disconnect();
                else log(event.data, 'friend');
            };
        }

        async function handleMainButton() {
            const action = btnMain.innerText;
            if (action === "CREATE OFFER") {
                btnMain.disabled = true; btnMain.innerText = "GENERATING...";
                createPeerConnection();
                dataChannel = peerConnection.createDataChannel("chat");
                setupDataChannel(dataChannel);
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
            } 
            else if (action === "GENERATE ANSWER" || action === "CONNECT") {
                const code = remoteSdpBox.value;
                if (!code) return;
                try {
                    const json = await decompress(code);
                    const desc = JSON.parse(json);
                    if (!peerConnection) {
                        createPeerConnection();
                        peerConnection.ondatachannel = (e) => setupDataChannel(e.channel);
                    }
                    await peerConnection.setRemoteDescription(desc);
                    lastProcessedRemoteCode = code;
                    
                    if (desc.type === 'offer') {
                        log("Generating Answer...");
                        const answer = await peerConnection.createAnswer();
                        await peerConnection.setLocalDescription(answer);
                    }
                    updateUI();
                } catch(e) { log("Invalid code."); }
            }
            else if (action === "DISCONNECT") {
                if(confirm("Disconnect?")) disconnect();
            }
        }

        function disconnect() {
            if (dataChannel?.readyState === 'open') dataChannel.send("SYSTEM:DISCONNECT");
            if (peerConnection) peerConnection.close();
            peerConnection = null; dataChannel = null;
            remoteVideo.srcObject = null;
            setConnectedState(false);
            
            // Reset View: Local -> Main
            localVideo.className = 'main-view';
            remoteVideo.className = 'pip-view';
            
            clearLocalCode(); clearRemoteCode();
            log("Disconnected.");
        }

        function updateUI() {
            if (isConnected) {
                btnMain.innerText = "DISCONNECT";
                btnMain.className = "std-btn btn-red";
                return;
            }
            const localVal = localSdpBox.value.trim();
            const remoteVal = remoteSdpBox.value.trim();
            
            document.getElementById('btnCopy').disabled = !localVal;
            
            if (!remoteVal) {
                btnMain.disabled = !!localVal;
                btnMain.innerText = localVal ? "OFFER CREATED" : "CREATE OFFER";
                btnMain.className = "std-btn btn-blue";
            } else if (remoteVal === lastProcessedRemoteCode) {
                btnMain.innerText = "WAITING...";
                btnMain.disabled = true;
                btnMain.className = "std-btn btn-grey";
            } else {
                btnMain.disabled = false;
                btnMain.innerText = localVal ? "CONNECT" : "GENERATE ANSWER";
                btnMain.className = localVal ? "std-btn btn-green" : "std-btn btn-blue";
            }
        }

        function setConnectedState(connected) {
            isConnected = connected;
            updateUI();
            chatInput.disabled = !connected;
            btnSend.disabled = !connected;
        }

        async function pasteFromClipboard() {
            try { remoteSdpBox.value = await navigator.clipboard.readText(); updateUI(); } catch(e){}
        }
        function copyToClipboard() { localSdpBox.select(); document.execCommand("copy"); }
        function clearLocalCode() { localSdpBox.value = ''; updateUI(); }
        function clearRemoteCode() { remoteSdpBox.value = ''; lastProcessedRemoteCode = ''; updateUI(); }
        
        function sendMessage() {
            const val = chatInput.value;
            if(val && dataChannel?.readyState === 'open') {
                dataChannel.send(val);
                log(val, 'me');
                chatInput.value = '';
            }
        }
        function handleEnter(e) { if(e.key==='Enter') sendMessage(); }

        // Start App
        startCamera();
    </script>
</body>
</html>