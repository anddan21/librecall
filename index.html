<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LibreCall v0.52</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#121212">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgZmlsbD0iIzEyMTIxMiIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjI1NiIgcj0iMTgwIiBmaWxsPSIjMDA3YmZmIi8+PHBhdGggZD0iTTI1NiAxNTZsLTQwIDQwIDQwIDQwIDQwLTQwLTQwLTQwem0wIDAgdjgwIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIwIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz48L3N2Zz4=">

    <style>
        /* --- CORE --- */
        body {
            background-color: #121212; color: #e0e0e0;
            font-family: 'Segoe UI', system-ui, sans-serif;
            margin: 0; display: flex; flex-direction: column; align-items: center;
            min-height: 100vh;
            padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom);
            box-sizing: border-box;
        }

        /* Header */
        h1 { 
            margin: 15px 0; font-weight: 200; font-size: 2.2rem;
            background: linear-gradient(45deg, #fff, #bbb);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            display: flex; align-items: baseline; justify-content: center; gap: 10px;
        }
        .version-tag { 
            font-size: 0.4em; -webkit-text-fill-color: #666; 
            font-weight: 400; transform: translateY(-2px);
        }

        /* --- CONTROLS --- */
        .controls {
            background: #1e1e1e; padding: 20px;
            border-radius: 16px; width: 95%; max-width: 600px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
            display: flex; flex-direction: column; gap: 15px;
            margin-bottom: 20px; z-index: 20;
            transition: all 0.3s ease;
        }

        /* Mode Selection */
        .mode-selector { display: flex; gap: 15px; }
        .mode-btn {
            flex: 1; padding: 20px; border: 2px solid #333;
            background: #252525; color: #fff; border-radius: 12px;
            font-size: 16px; font-weight: bold; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; gap: 5px;
            transition: all 0.2s;
        }
        .mode-btn span { font-size: 12px; font-weight: normal; color: #888; }
        .mode-btn:hover { background: #333; border-color: #555; }
        .mode-btn:active { transform: scale(0.98); }

        /* Panels */
        .panel { display: none; flex-direction: column; gap: 15px; animation: fadeIn 0.3s; }
        .panel.visible { display: flex; }
        @keyframes fadeIn { from {opacity:0} to {opacity:1} }

        /* Steps */
        .step-box {
            background: #2a2a2a; padding: 12px; border-radius: 8px;
            border-left: 4px solid #444;
        }
        .step-title { font-size: 12px; font-weight: bold; color: #aaa; margin-bottom: 8px; text-transform: uppercase; }
        .step-active { border-left-color: #00ff9d; }
        .step-wait { border-left-color: #ff9800; }

        /* Inputs */
        .input-group { display: flex; gap: 8px; }
        textarea.code-box {
            flex-grow: 1; height: 45px;
            background: #111; color: #00ff9d;
            border: 1px solid #444; border-radius: 6px;
            font-family: monospace; font-size: 11px; padding: 8px;
            box-sizing: border-box; resize: none;
        }
        textarea.code-box:focus { outline: none; border-color: #007bff; }
        textarea.code-box.error { border-color: #ff4444; }

        /* Buttons */
        button.action-btn {
            width: 100%; padding: 12px; border: none; border-radius: 8px;
            font-weight: 600; color: white; cursor: pointer; text-transform: uppercase;
        }
        button.action-btn:disabled { background: #333 !important; color: #666; cursor: not-allowed; }
        
        button.side-btn {
            width: 60px; padding: 0; border: none; border-radius: 6px;
            background: #444; color: #fff; font-size: 10px; font-weight: bold;
            cursor: pointer; text-transform: uppercase;
        }
        button.side-btn:active { background: #666; }

        .btn-blue { background: #007bff; }
        .btn-green { background: #28a745; }
        .btn-red { background: #dc3545; }
        .btn-grey { background: #444; }

        /* Chat */
        #chatLog {
            height: 120px; background: #000;
            border: 1px solid #333; border-radius: 8px;
            overflow-y: auto; padding: 10px; font-family: monospace; font-size: 12px;
        }
        .msg-sys { color: #ff4444; font-weight: bold; margin-left: 5px; }
        .msg-me { color: #4caf50; margin-left: 5px; }
        .msg-peer { color: #00bfff; margin-left: 5px; }
        .sys { color: #ff4444; font-weight: bold; }
        .me { color: #4caf50; font-weight: bold; }
        .peer { color: #00bfff; font-weight: bold; }

        .chat-row { display: flex; gap: 8px; }
        .chat-input { flex: 1; padding: 10px; background: #222; border: 1px solid #444; color: #fff; border-radius: 6px; }

        /* Media */
        .media-row { display: flex; gap: 10px; margin-top: 10px; }
        .media-btn { 
            flex: 1; height: 50px; border-radius: 8px; border: none; 
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            transition: background 0.2s;
        }
        .media-btn svg { width: 24px; fill: #fff; }
        .media-on { background: #333; }
        .media-off { background: #d32f2f; }

        /* Video */
        .video-stage {
            position: relative; width: 95%; max-width: 800px;
            aspect-ratio: 16/9; background: #000;
            border-radius: 16px; border: 1px solid #333;
            overflow: hidden; display: flex; align-items: center; justify-content: center;
            margin-bottom: 20px;
        }
        .placeholder { position: absolute; color: #444; font-weight: 500; }
        .main-view { width: 100%; height: 100%; object-fit: cover; position: absolute; z-index: 1; }
        .pip-view { 
            width: 25%; aspect-ratio: 16/9; object-fit: cover; 
            position: absolute; bottom: 15px; right: 15px; z-index: 10;
            border-radius: 8px; border: 2px solid rgba(255,255,255,0.3);
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); cursor: pointer;
        }

        body.connected .mode-selector, body.connected .panel { display: none !important; }
        
        @media (max-width: 768px) {
            .video-stage { aspect-ratio: 4/5; }
            .pip-view { width: 30%; bottom: 10px; right: 10px; }
        }
    </style>
</head>
<body>

    <script>
        const m={name:"LibreCall",display:"standalone",background_color:"#121212",theme_color:"#121212",icons:[{src:"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgZmlsbD0iIzEyMTIxMiIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjI1NiIgcj0iMTgwIiBmaWxsPSIjMDA3YmZmIi8+PHBhdGggZD0iTTI1NiAxNTZsLTQwIDQwIDQwIDQwIDQwLTQwLTQwLTQwem0wIDAgdjgwIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIwIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz48L3N2Zz4=",sizes:"512x512",type:"image/svg+xml"}]};
        document.querySelector('link[rel="manifest"]').href = URL.createObjectURL(new Blob([JSON.stringify(m)],{type:'application/json'}));
    </script>

    <h1>LibreCall<span class="version-tag">v0.52</span></h1>

    <div class="controls">
        
        <div id="modeSelector" class="mode-selector">
            <button class="mode-btn" onclick="selectMode('host')">
                START CALL <span>(Send Invite)</span>
            </button>
            <button class="mode-btn" onclick="selectMode('join')">
                JOIN CALL <span>(Accept Invite)</span>
            </button>
        </div>

        <div id="hostPanel" class="panel">
            <div class="step-box step-active">
                <div class="step-title">Step 1: Send Invitation</div>
                <div class="input-group">
                    <textarea id="hostOffer" class="code-box" readonly placeholder="Generating..."></textarea>
                    <button class="side-btn" onclick="copyToClip('hostOffer')">COPY</button>
                </div>
            </div>
            <div class="step-box step-wait">
                <div class="step-title">Step 2: Paste Confirmation</div>
                <div class="input-group">
                    <textarea id="hostAnswer" class="code-box" placeholder="Paste confirmation code..." oninput="validateInput(this)"></textarea>
                    <button class="side-btn" onclick="pasteToField('hostAnswer')">PASTE</button>
                </div>
                <button id="btnHostConnect" class="action-btn btn-green" style="margin-top:10px" onclick="hostConnect()" disabled>CONNECT</button>
            </div>
            <button class="action-btn btn-grey" onclick="resetApp()">BACK</button>
        </div>

        <div id="joinPanel" class="panel">
            <div class="step-box step-wait">
                <div class="step-title">Step 1: Paste Invitation</div>
                <div class="input-group">
                    <textarea id="joinOffer" class="code-box" placeholder="Paste invite code..." oninput="joinCheckOffer()"></textarea>
                    <button class="side-btn" onclick="pasteToField('joinOffer')">PASTE</button>
                </div>
                <button id="btnJoinGen" class="action-btn btn-blue" style="margin-top:10px" onclick="joinGenerate()" disabled>CREATE CONFIRMATION</button>
            </div>
            <div id="joinStep2" class="step-box" style="opacity:0.5; pointer-events:none;">
                <div class="step-title">Step 2: Send Confirmation</div>
                <div class="input-group">
                    <textarea id="joinAnswer" class="code-box" readonly placeholder="..."></textarea>
                    <button class="side-btn" onclick="copyToClip('joinAnswer')">COPY</button>
                </div>
            </div>
            <button class="action-btn btn-grey" onclick="resetApp()">BACK</button>
        </div>

        <button id="btnDisconnect" class="action-btn btn-red" style="display:none" onclick="doDisconnect(true, 'Call ended by YOU.')">DISCONNECT</button>

        <div id="chatLog"></div>
        <div class="chat-row">
            <input id="chatInput" class="chat-input" placeholder="Message..." disabled onkeypress="if(event.key==='Enter') doSend()">
            <button id="btnSend" class="action-btn btn-blue" style="width:auto;" onclick="doSend()" disabled>></button>
        </div>

        <div class="media-row">
            <button id="btnVideo" class="media-btn media-off" onclick="toggleMedia('video')"></button>
            <button id="btnAudio" class="media-btn media-off" onclick="toggleMedia('audio')"></button>
        </div>
    </div>

    <div id="videoContainer" class="video-stage">
        <div class="placeholder">Waiting...</div>
        <video id="remoteVideo" class="main-view" autoplay playsinline onclick="vidClick(this)"></video>
        <video id="localVideo" class="pip-view" autoplay playsinline muted onclick="vidClick(this)"></video>
    </div>

    <script>
        const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
        const el = id => document.getElementById(id);
        const ICONS = {
            camOn: '<svg viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg>',
            camOff: '<svg viewBox="0 0 24 24"><path d="M9.56 8l-2-2-4.15-4.15L2 3.27 4.73 6H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.21 0 .39-.08.54-.18L19.73 21l1.27-1.27-11.44-11.73zM16 16.17L5.83 6H16v10.17zM18 7c0-.55-.45-1-1-1h-2.17l2 2V7zm2 8.17V7l-4 3.33V12l2.34 2.34L20 15.17z"/></svg>',
            micOn: '<svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>',
            micOff: '<svg viewBox="0 0 24 24"><path d="M19 11h-1.7c0 .74-.16 1.43-.43 2.05l1.23 1.23c.56-.98.9-2.09.9-3.28zm-4.02.17c0-.06.02-.11.02-.17V5c0-1.66-1.34-3-3-3S9 3.34 9 5v.18l5.98 5.99zM4.27 3L3 4.27l6.01 6.01V11c0 1.66 1.33 3 2.99 3 .22 0 .44-.03.65-.08l2.97 2.97c-.85.35-1.76.57-2.75.57-3.7 0-6.73-2.94-6.88-6.6l-.01.03H4.15c.16 4.61 3.75 8.41 8.35 8.9V21h3v-1.14l4.22 4.23L21 22.73 4.27 3z"/></svg>'
        };

        let pc, dc, localStream, isHost = false; 
        let iceComplete = false; // Flag to track ICE completion

        // --- WIZARD LOGIC ---
        function selectMode(mode) {
            el('modeSelector').style.display = 'none';
            if (mode === 'host') {
                isHost = true;
                el('hostPanel').classList.add('visible');
                createPC(); 
                dc = pc.createDataChannel("chat");
                setupDC(dc);
                pc.createOffer().then(d => pc.setLocalDescription(d));
                log("Generating Invitation...", 'sys');
            } else {
                isHost = false;
                el('joinPanel').classList.add('visible');
                log("Waiting for Invite Code...", 'sys');
            }
        }

        function resetApp() {
            doDisconnect(false, "Reset.");
            el('hostPanel').classList.remove('visible');
            el('joinPanel').classList.remove('visible');
            el('modeSelector').style.display = 'flex';
            ['hostOffer','hostAnswer','joinOffer','joinAnswer'].forEach(i => el(i).value = '');
            el('joinStep2').style.opacity = '0.5';
            el('joinStep2').style.pointerEvents = 'none';
            el('hostAnswer').classList.remove('error');
            el('joinOffer').classList.remove('error');
        }

        function hostConnect() {
            const code = el('hostAnswer').value.trim();
            if(!validateInput(el('hostAnswer'))) return;
            try {
                const desc = JSON.parse(atob(code));
                pc.setRemoteDescription(desc);
                log("Confirmation accepted. Connecting...", 'sys');
            } catch(e) { log("Error: Bad code", 'sys'); }
        }

        function joinCheckOffer() {
            const val = el('joinOffer').value.trim();
            const btn = el('btnJoinGen');
            if (validateInput(el('joinOffer'))) btn.disabled = false;
            else btn.disabled = true;
        }

        function joinGenerate() {
            const code = el('joinOffer').value.trim();
            createPC();
            pc.ondatachannel = e => setupDC(e.channel);
            
            try {
                const desc = JSON.parse(atob(code));
                pc.setRemoteDescription(desc)
                .then(() => pc.createAnswer())
                .then(a => pc.setLocalDescription(a))
                .then(() => log("Generating Confirmation...", 'sys'));
            } catch(e) { log("Invalid Invite Code", 'sys'); }
        }

        // --- WEBRTC CORE (With ICE Failsafe) ---
        function createPC() {
            pc = new RTCPeerConnection(config);
            localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
            pc.ontrack = e => el('remoteVideo').srcObject = e.streams[0];
            
            iceComplete = false;
            
            // 1. Standard ICE Gathering
            pc.onicecandidate = e => {
                if (!e.candidate) finalizeIce(); // All done
            };
            
            // 2. Failsafe Timer (Crucial for Mobile!)
            setTimeout(() => {
                if (!iceComplete && pc && pc.localDescription) {
                    log("Network slow. Forcing generation...", 'sys');
                    finalizeIce();
                }
            }, 1000); // 1 second timeout
            
            pc.onconnectionstatechange = () => {
                if (pc.connectionState === 'connected') setConnected(true);
                if (pc.connectionState === 'failed') doDisconnect(false, "Connection Lost");
            };
        }

        function finalizeIce() {
            if (iceComplete) return;
            iceComplete = true;
            
            // Generate Code
            const code = btoa(JSON.stringify(pc.localDescription));
            
            if (isHost) {
                el('hostOffer').value = code;
                log("Invitation Generated!", 'sys');
            } else {
                el('joinAnswer').value = code;
                // Enable UI for Step 2
                el('joinStep2').style.opacity = '1';
                el('joinStep2').style.pointerEvents = 'all';
                el('btnJoinGen').disabled = true;
                el('btnJoinGen').innerText = "DONE";
                log("Confirmation Generated!", 'sys');
            }
        }

        async function start() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
                el('localVideo').srcObject = localStream;
                localStream.getTracks().forEach(t => t.enabled = false);
                updateMediaBtns();
                log("Devices Ready.", 'sys');
            } catch(e) { log("Camera blocked.", 'sys'); }
        }

        // --- REST OF LOGIC ---
        function setupDC(channel) {
            dc = channel;
            dc.onopen = () => { log("Connected!", 'sys'); setConnected(true); };
            dc.onmessage = e => {
                if(e.data === "SYS:END") doDisconnect(false, "Call ended by FRIEND.");
                else log(e.data, 'peer');
            }
        }

        function setConnected(state) {
            if (state) {
                document.body.classList.add('connected');
                el('btnDisconnect').style.display = 'block';
                el('chatInput').disabled = false;
                el('btnSend').disabled = false;
                el('remoteVideo').className = 'main-view';
                el('localVideo').className = 'pip-view';
            } else {
                document.body.classList.remove('connected');
                el('btnDisconnect').style.display = 'none';
                el('chatInput').disabled = true;
                el('btnSend').disabled = true;
                el('remoteVideo').srcObject = null;
            }
        }

        function doDisconnect(notify, reason) {
            if (notify && dc?.readyState === 'open') dc.send("SYS:END");
            if (pc) pc.close();
            pc = null; dc = null;
            setConnected(false);
            log(reason, 'sys');
        }

        function validateInput(elem) {
            const str = elem.value.trim();
            let isValid = false;
            try { 
                const j = JSON.parse(atob(str)); 
                if (j.type && j.sdp) isValid = true; 
            } catch(e){}
            
            if (str.length > 0 && !isValid) {
                elem.classList.add('error');
                if(elem.id === 'hostAnswer') el('btnHostConnect').disabled = true;
                return false;
            }
            elem.classList.remove('error');
            if(elem.id === 'hostAnswer' && isValid) el('btnHostConnect').disabled = false;
            return isValid;
        }

        function copyToClip(id) { el(id).select(); document.execCommand('copy'); }
        
        async function pasteToField(id) {
            try {
                const text = await navigator.clipboard.readText();
                const field = el(id);
                field.value = text;
                if(id === 'hostAnswer') validateInput(field);
                if(id === 'joinOffer') joinCheckOffer();
            } catch(e) { log("Clipboard blocked.", 'sys'); }
        }

        function doSend() {
            const v = el('chatInput').value;
            if(v && dc?.readyState==='open') { dc.send(v); log(v, 'me'); el('chatInput').value=''; }
        }

        function log(m, type) {
            const d = document.createElement('div');
            const t = new Date().toLocaleTimeString();
            let n = "SYS", c = "sys", b = "msg-sys";
            if(type==='me') { n="YOU"; c="me"; b="msg-me"; }
            if(type==='peer') { n="FRIEND"; c="peer"; b="msg-peer"; }
            d.innerHTML = `<span style="color:#666">[${t}]</span> <span class="${c}">${n}:</span> <span class="${b}">${m}</span>`;
            el('chatLog').append(d); el('chatLog').scrollTop = 9999;
        }

        function toggleMedia(type) {
            if(!localStream) return;
            const tr = type==='video' ? localStream.getVideoTracks()[0] : localStream.getAudioTracks()[0];
            tr.enabled = !tr.enabled;
            updateMediaBtns();
        }

        function updateMediaBtns() {
            const v = localStream.getVideoTracks()[0].enabled;
            const a = localStream.getAudioTracks()[0].enabled;
            
            el('btnVideo').className = v ? "media-btn media-on" : "media-btn media-off";
            el('btnVideo').innerHTML = v ? ICONS.camOn : ICONS.camOff;
            
            el('btnAudio').className = a ? "media-btn media-on" : "media-btn media-off";
            el('btnAudio').innerHTML = a ? ICONS.micOn : ICONS.micOff;
        }

        function vidClick(v) {
            if (v.classList.contains('pip-view')) {
                const isLocalPip = el('localVideo').classList.contains('pip-view');
                el('localVideo').className = isLocalPip ? 'main-view' : 'pip-view';
                el('remoteVideo').className = isLocalPip ? 'pip-view' : 'main-view';
            } else {
                const c = el('videoContainer');
                if(!document.fullscreenElement) c.requestFullscreen().catch(e=>{});
                else document.exitFullscreen();
            }
        }

        start();
    </script>
</body>
</html>