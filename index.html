<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LibreCall v2.2</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#121212">
    <meta name="mobile-web-app-capable" content="yes">
    
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LibreCall">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgZmlsbD0iIzEyMTIxMiIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjI1NiIgcj0iMTgwIiBmaWxsPSIjMDA3YmZmIi8+PHBhdGggZD0iTTI1NiAxNTZsLTQwIDQwIDQwIDQwIDQwLTQwLTQwLTQwem0wIDAgdjgwIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIwIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz48L3N2Zz4=">

    <link rel="manifest" id="my-manifest-placeholder">

    <style>
        /* --- GLOBAL STYLES --- */
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            height: -webkit-fill-available;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            box-sizing: border-box;
        }

        /* --- HEADER --- */
        h1 { 
            margin: 20px 0 10px 0; 
            font-weight: 200; 
            letter-spacing: 2px;
            font-size: 2.8rem;
            background: linear-gradient(45deg, #ffffff, #b0b0b0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 4px 12px rgba(0,0,0,0.5);
            text-align: center;
        }
        
        .version-tag {
            font-size: 0.4em;
            vertical-align: baseline;
            opacity: 0.8;           
            letter-spacing: 1px;
            font-weight: 400;     
            margin-left: 10px;
            -webkit-text-fill-color: #00ff9d; /* Green for success */
            text-shadow: none;
        }

        /* --- VIDEO AREA --- */
        .videos {
            display: flex;
            gap: 20px;
            width: 90%;
            max-width: 1200px;
            justify-content: center;
            flex-shrink: 0;
        }

        video {
            width: 45%;
            aspect-ratio: 16/9;
            background-color: #000;
            border-radius: 12px;
            border: 1px solid #333;
            object-fit: cover;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        /* --- CONTROLS CONTAINER --- */
        .controls {
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            margin-top: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.4);
            display: flex;
            flex-direction: row;
            gap: 20px;
        }

        .signaling-col { flex: 1; display: flex; flex-direction: column; gap: 8px; }
        .chat-col { flex: 1; display: flex; flex-direction: column; gap: 12px; }

        /* --- TEXT LABELS --- */
        .code-label {
            font-size: 11px;
            font-weight: 700;
            color: #ccc;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 5px;
            margin-bottom: -5px;
        }

        /* --- INPUTS & TEXTAREAS --- */
        textarea.code-box {
            width: 100%;
            height: 50px;
            background-color: #2b2b2b;
            color: #00ff9d;
            border: 1px solid #444;
            border-radius: 8px;
            font-family: monospace;
            resize: none;
            font-size: 11px;
            padding: 8px;
            box-sizing: border-box;
            word-break: break-all;
        }

        input.chat-input {
            padding: 10px;
            background: #2b2b2b;
            border: 1px solid #444;
            color: white;
            border-radius: 8px;
            outline: none;
            font-size: 16px;
        }
        input.chat-input:focus { border-color: #007bff; }

        #chatLog {
            flex-grow: 1;
            height: 200px;
            background-color: #000;
            border: 1px solid #333;
            border-radius: 8px;
            overflow-y: auto;
            padding: 10px;
            font-family: monospace;
            font-size: 13px;
            text-align: left;
        }

        .system-msg { color: #ff4444; font-weight: bold; }
        .user-msg { color: #fff; }
        .my-msg { color: #4caf50; }

        /* --- BUTTONS --- */
        button.std-btn {
            padding: 12px;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            touch-action: manipulation;
        }
        button.std-btn:hover { opacity: 0.9; transform: translateY(-1px); }
        button.std-btn:disabled { 
            background-color: #333 !important; 
            color: #666; 
            cursor: not-allowed; 
            transform: none; 
            font-weight: 400;
        }
        
        button.sub-btn {
            padding: 8px;
            cursor: pointer;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            transition: background 0.2s;
            color: white;
            background-color: #444;
            touch-action: manipulation;
        }
        button.sub-btn:hover { background-color: #555; }
        button.sub-btn:disabled { background-color: #333; color: #555; cursor: not-allowed; }

        .btn-blue { background-color: #007bff; }
        .btn-green { background-color: #28a745; }
        .btn-cyan { background-color: #17a2b8; }
        .btn-red { background-color: #dc3545; }
        .btn-grey { background-color: #444; }

        .btn-group { display: flex; gap: 10px; margin-top: 5px; }
        .btn-group button { flex: 1; }

        /* --- ICON BUTTONS --- */
        .media-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
            padding: 10px;
            background: #121212;
            border-radius: 50px;
            border: 1px solid #333;
        }

        .icon-btn {
            width: 50px;
            height: 50px;
            padding: 0;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            touch-action: manipulation;
        }
        
        .icon-btn:hover { transform: scale(1.05); filter: brightness(1.2); }
        .icon-btn svg { width: 24px; height: 24px; fill: white; }

        .media-off { background-color: #d32f2f; }
        .media-on { background-color: #424242; }

        /* --- MOBILE RESPONSIVE --- */
        @media (max-width: 768px) {
            h1 { font-size: 2rem; margin-top: 10px; }
            
            .videos {
                flex-direction: column;
                width: 95%;
                gap: 10px;
            }
            
            video {
                width: 100%;
                aspect-ratio: 16/9;
                height: auto;
            }
            
            .controls {
                flex-direction: column;
                padding: 15px;
                width: 92%;
                gap: 25px;
            }
            
            .signaling-col, .chat-col {
                width: 100%;
            }

            #chatLog {
                height: 150px;
            }

            button.std-btn, button.icon-btn {
                min-height: 48px;
            }
        }

    </style>
</head>
<body>

    <script>
        // --- PWA MANIFEST GENERATION ---
        const manifest = {
            "name": "LibreCall Secure",
            "short_name": "LibreCall",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#121212",
            "theme_color": "#121212",
            "orientation": "portrait",
            "icons": [{
                "src": "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgZmlsbD0iIzEyMTIxMiIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjI1NiIgcj0iMTgwIiBmaWxsPSIjMDA3YmZmIi8+PHBhdGggZD0iTTI1NiAxNTZsLTQwIDQwIDQwIDQwIDQwLTQwLTQwLTQwem0wIDAgdjgwIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIwIiBzdHJva2UtbGluZWNhcD0icm91bmQiLz48L3N2Zz4=">

    <link rel="manifest" id="my-manifest-placeholder">

    <script>
        // Inject Manifest
        const stringManifest = JSON.stringify(manifest);
        const blob = new Blob([stringManifest], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(blob);
        document.querySelector('#my-manifest-placeholder').setAttribute('href', manifestURL);
    </script>

    <h1>LibreCall<span class="version-tag">v2.2</span></h1>

    <div class="videos">
        <video id="localVideo" autoplay playsinline muted></video>
        <video id="remoteVideo" autoplay playsinline></video>
    </div>

    <div class="controls">
        
        <div class="signaling-col">
            
            <div class="media-bar">
                <button id="btnVideo" class="icon-btn media-off" onclick="toggleVideo()" title="Toggle Camera">
                    <svg viewBox="0 0 24 24"><path d="M9.56 8l-2-2-4.15-4.15L2 3.27 4.73 6H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.21 0 .39-.08.54-.18L19.73 21l1.27-1.27-11.44-11.73zM16 16.17L5.83 6H16v10.17zM18 7c0-.55-.45-1-1-1h-2.17l2 2V7zm2 8.17V7l-4 3.33V12l2.34 2.34L20 15.17z"/></svg>
                </button>
                <button id="btnAudio" class="icon-btn media-off" onclick="toggleAudio()" title="Toggle Microphone">
                    <svg viewBox="0 0 24 24"><path d="M19 11h-1.7c0 .74-.16 1.43-.43 2.05l1.23 1.23c.56-.98.9-2.09.9-3.28zm-4.02.17c0-.06.02-.11.02-.17V5c0-1.66-1.34-3-3-3S9 3.34 9 5v.18l5.98 5.99zM4.27 3L3 4.27l6.01 6.01V11c0 1.66 1.33 3 2.99 3 .22 0 .44-.03.65-.08l2.97 2.97c-.85.35-1.76.57-2.75.57-3.7 0-6.73-2.94-6.88-6.6l-.01.03H4.15c.16 4.61 3.75 8.41 8.35 8.9V21h3v-1.14l4.22 4.23L21 22.73 4.27 3z"/></svg>
                </button>
            </div>

            <button id="btnMain" class="std-btn btn-blue" onclick="handleMainButton()">Create Offer</button>
            
            <div class="code-label">Your Code (Send to friend)</div>
            <textarea id="localSdp" class="code-box" readonly placeholder="Code will appear here..."></textarea>
            
            <div class="btn-group">
                <button id="btnCopy" class="sub-btn" onclick="copyToClipboard()" disabled>Copy</button>
                <button id="btnClearLocal" class="sub-btn" onclick="clearLocalCode()" disabled>Clear</button>
            </div>

            <hr style="border-color: #333; width: 100%;">

            <div class="code-label">Friend's Code (Paste here)</div>
            <textarea id="remoteSdp" class="code-box" placeholder="Paste code here..." oninput="updateUI()"></textarea>
            
            <div class="btn-group">
                <button id="btnPaste" class="sub-btn" onclick="pasteFromClipboard()">Paste</button>
                <button id="btnClearRemote" class="sub-btn" onclick="clearRemoteCode()" disabled>Clear</button>
            </div>
        </div>

        <div class="chat-col">
            <h3 style="margin: 0; color: #888;">System Log & Chat</h3>
            <div id="chatLog"></div>
            <div style="display: flex; gap: 5px;">
                <input type="text" id="chatInput" class="chat-input" placeholder="Type a message..." style="flex-grow: 1;" onkeypress="handleEnter(event)">
                <button class="std-btn btn-blue" style="padding: 0 20px;" onclick="sendMessage()">Send</button>
            </div>
        </div>

    </div>

    <script>
        const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
        
        const ICONS = {
            videoOn: '<svg viewBox="0 0 24 24"><path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z"/></svg>',
            videoOff: '<svg viewBox="0 0 24 24"><path d="M9.56 8l-2-2-4.15-4.15L2 3.27 4.73 6H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.21 0 .39-.08.54-.18L19.73 21l1.27-1.27-11.44-11.73zM16 16.17L5.83 6H16v10.17zM18 7c0-.55-.45-1-1-1h-2.17l2 2V7zm2 8.17V7l-4 3.33V12l2.34 2.34L20 15.17z"/></svg>',
            micOn: '<svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>',
            micOff: '<svg viewBox="0 0 24 24"><path d="M19 11h-1.7c0 .74-.16 1.43-.43 2.05l1.23 1.23c.56-.98.9-2.09.9-3.28zm-4.02.17c0-.06.02-.11.02-.17V5c0-1.66-1.34-3-3-3S9 3.34 9 5v.18l5.98 5.99zM4.27 3L3 4.27l6.01 6.01V11c0 1.66 1.33 3 2.99 3 .22 0 .44-.03.65-.08l2.97 2.97c-.85.35-1.76.57-2.75.57-3.7 0-6.73-2.94-6.88-6.6l-.01.03H4.15c.16 4.61 3.75 8.41 8.35 8.9V21h3v-1.14l4.22 4.23L21 22.73 4.27 3z"/></svg>'
        };

        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const chatLog = document.getElementById('chatLog');
        const localSdpBox = document.getElementById('localSdp');
        const remoteSdpBox = document.getElementById('remoteSdp');
        const chatInput = document.getElementById('chatInput');
        
        const btnMain = document.getElementById('btnMain');
        const btnCopy = document.getElementById('btnCopy');
        const btnClearLocal = document.getElementById('btnClearLocal');
        const btnPaste = document.getElementById('btnPaste');
        const btnClearRemote = document.getElementById('btnClearRemote');
        
        const btnVideo = document.getElementById('btnVideo');
        const btnAudio = document.getElementById('btnAudio');

        let localStream;
        let peerConnection;
        let dataChannel;
        let isConnected = false;
        let lastProcessedRemoteCode = '';
        let offerGenerated = false;

        function log(msg, type = 'system') {
            const line = document.createElement('div');
            const time = new Date().toLocaleTimeString();
            if (type === 'system') {
                line.className = 'system-msg';
                line.innerText = `[${time}] SYSTEM: ${msg}`;
            } else if (type === 'me') {
                line.className = 'my-msg';
                line.innerText = `[${time}] Me: ${msg}`;
            } else {
                line.className = 'user-msg';
                line.innerText = `[${time}] Friend: ${msg}`;
            }
            chatLog.appendChild(line);
            chatLog.scrollTop = chatLog.scrollHeight;
        }

        async function compress(string) {
            try {
                if (!window.CompressionStream) {
                    throw new Error("Compression not supported");
                }
                const stream = new Blob([string]).stream();
                const compressedReadableStream = stream.pipeThrough(new CompressionStream("gzip"));
                const compressedResponse = await new Response(compressedReadableStream);
                const blob = await compressedResponse.blob();
                const buffer = await blob.arrayBuffer();
                return btoa(String.fromCharCode(...new Uint8Array(buffer)));
            } catch(e) {
                console.warn("Compression failed, using raw JSON", e);
                return btoa(string);
            }
        }

        async function decompress(base64) {
            const cleanBase64 = base64.replace(/\s+/g, '').trim();
            if (!cleanBase64) throw new Error("Empty code");
            
            try {
                if (!window.DecompressionStream) {
                    throw new Error("Decompression not supported");
                }
                const binaryString = atob(cleanBase64);
                try {
                    const bytes = Uint8Array.from(binaryString, c => c.charCodeAt(0));
                    const stream = new Blob([bytes]).stream();
                    const decompressedReadableStream = stream.pipeThrough(new DecompressionStream("gzip"));
                    const decompressedResponse = await new Response(decompressedReadableStream);
                    return await decompressedResponse.text();
                } catch (gzipErr) {
                    return binaryString;
                }
            } catch(e) {
                 return atob(cleanBase64);
            }
        }

        function toggleVideo() {
            if (!localStream) return;
            const track = localStream.getVideoTracks()[0];
            track.enabled = !track.enabled;
            updateMediaUI();
        }

        function toggleAudio() {
            if (!localStream) return;
            const track = localStream.getAudioTracks()[0];
            track.enabled = !track.enabled;
            updateMediaUI();
        }

        function updateMediaUI() {
            if (!localStream) return;
            const videoOn = localStream.getVideoTracks()[0].enabled;
            const audioOn = localStream.getAudioTracks()[0].enabled;
            if (videoOn) {
                btnVideo.className = "icon-btn media-on";
                btnVideo.innerHTML = ICONS.videoOn;
            } else {
                btnVideo.className = "icon-btn media-off";
                btnVideo.innerHTML = ICONS.videoOff;
            }
            if (audioOn) {
                btnAudio.className = "icon-btn media-on";
                btnAudio.innerHTML = ICONS.micOn;
            } else {
                btnAudio.className = "icon-btn media-off";
                btnAudio.innerHTML = ICONS.micOff;
            }
        }

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localStream = stream;
                localVideo.srcObject = stream;
                
                // Privacy First: Start Muted/Hidden
                stream.getVideoTracks()[0].enabled = false;
                stream.getAudioTracks()[0].enabled = false;
                
                updateMediaUI();
                
                let devices = [];
                if (stream.getVideoTracks().length > 0) devices.push("Camera");
                if (stream.getAudioTracks().length > 0) devices.push("Microphone");
                
                log(`Devices ready: ${devices.join(" & ")}.`);
                
            } catch (err) {
                console.error(err);
                log("Error: Camera access denied. Ensure HTTPS.", 'system');
            }
        }

        async function finalizeCodeGeneration() {
            if (offerGenerated) return;
            offerGenerated = true;

            let sdp = peerConnection.localDescription.sdp;
            const json = JSON.stringify({ type: peerConnection.localDescription.type, sdp: sdp });
            
            try {
                const compressed = await compress(json);
                localSdpBox.value = compressed;
                updateUI();
                log(`Code generated! Size: ${compressed.length} chars. Send it to your friend.`);
            } catch (e) {
                log("Error generating code: " + e.message, 'system');
            }
        }

        function createPeerConnection() {
            peerConnection = new RTCPeerConnection(config);
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            peerConnection.ontrack = (event) => {
                remoteVideo.srcObject = event.streams[0];
            };

            peerConnection.onconnectionstatechange = () => {
                if (peerConnection.connectionState === 'connected') {
                    setConnectedState(true);
                } else if (peerConnection.connectionState === 'disconnected') {
                    setConnectedState(false);
                    log("Peer disconnected.");
                }
            };

            offerGenerated = false;

            peerConnection.onicecandidate = async (event) => {
                if (event.candidate === null) {
                    await finalizeCodeGeneration();
                }
            };

            setTimeout(() => {
                if (!offerGenerated && peerConnection.iceGatheringState !== 'complete') {
                    log("Network slow. Forcing code generation...", 'system');
                    finalizeCodeGeneration();
                }
            }, 2000);
        }

        function setupDataChannel(channel) {
            channel.onopen = () => {
                log("Connection established. Happy LibreCall!", 'system');
                chatInput.disabled = false;
                // FIX: Removed auto-focus to prevent keyboard popup
                setConnectedState(true);
            };
            channel.onmessage = (event) => {
                if (event.data === "SYSTEM:DISCONNECT") {
                    log("Friend disconnected.", 'system');
                    performDisconnect();
                } else {
                    log(event.data, 'friend');
                }
            };
        }

        async function handleMainButton() {
            const action = btnMain.innerText;
            
            if (action === "CREATE OFFER") {
                // FIX: Immediately disable button to prevent double clicks
                btnMain.disabled = true;
                btnMain.innerText = "GENERATING...";
                await createOffer();
            } 
            else if (action === "GENERATE ANSWER") {
                await handleRemoteSdp();
            } 
            else if (action === "CONNECT") {
                await handleRemoteSdp();
            } 
            else if (action === "DISCONNECT") {
                if (confirm("Are you sure you want to disconnect?")) {
                    disconnect();
                }
            }
        }

        function disconnect() {
            if (dataChannel && dataChannel.readyState === 'open') {
                try {
                    dataChannel.send("SYSTEM:DISCONNECT");
                } catch(e) { console.log("Could not send disconnect msg"); }
            }
            performDisconnect();
            log("Disconnected.");
        }

        function performDisconnect() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if (dataChannel) dataChannel.close();
            remoteVideo.srcObject = null;
            setConnectedState(false);
            clearLocalCode();
            clearRemoteCode();
            offerGenerated = false;
        }

        async function createOffer() {
            log("Generating Offer...");
            createPeerConnection();
            dataChannel = peerConnection.createDataChannel("chat");
            setupDataChannel(dataChannel);
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
        }

        async function handleRemoteSdp() {
            const code = remoteSdpBox.value;
            if (!code) return;
            try {
                if (code === localSdpBox.value) {
                    log("Error: You pasted your own code!", 'system');
                    remoteSdpBox.value = '';
                    updateUI();
                    return;
                }
                const json = await decompress(code);
                const remoteDesc = JSON.parse(json);
                if (!peerConnection) {
                    createPeerConnection();
                    peerConnection.ondatachannel = (event) => {
                        dataChannel = event.channel;
                        setupDataChannel(dataChannel);
                    };
                }
                await peerConnection.setRemoteDescription(remoteDesc);
                
                lastProcessedRemoteCode = code;

                if (remoteDesc.type === 'offer') {
                    log("Offer received. Generating Answer...");
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                } else if (remoteDesc.type === 'answer') {
                    log("Answer accepted. Finalizing...");
                }
                updateUI();
            } catch (err) {
                console.error(err);
                log("Error: Invalid code format.", 'system');
            }
        }

        function updateUI() {
            const localVal = localSdpBox.value.trim();
            const remoteVal = remoteSdpBox.value.trim();

            btnClearLocal.disabled = (localVal.length === 0);
            btnCopy.disabled = (localVal.length === 0);
            btnClearRemote.disabled = (remoteVal.length === 0);

            if (isConnected) {
                btnMain.innerText = "DISCONNECT";
                btnMain.className = "std-btn btn-red";
                btnMain.disabled = false;
                return;
            }

            if (remoteVal.length === 0) {
                if (localVal.length === 0) {
                    // Reset text if disconnected or new session
                    btnMain.innerText = "CREATE OFFER";
                    btnMain.className = "std-btn btn-blue";
                    btnMain.disabled = false;
                } else {
                    btnMain.innerText = "OFFER CREATED";
                    btnMain.className = "std-btn btn-blue";
                    btnMain.disabled = true;
                }
                return;
            }

            if (remoteVal === lastProcessedRemoteCode) {
                btnMain.innerText = "WAITING...";
                btnMain.className = "std-btn btn-grey";
                btnMain.disabled = true;
            } else {
                if (localVal.length === 0) {
                    btnMain.innerText = "GENERATE ANSWER";
                    btnMain.className = "std-btn btn-cyan";
                    btnMain.disabled = false;
                } else {
                    btnMain.innerText = "CONNECT";
                    btnMain.className = "std-btn btn-green";
                    btnMain.disabled = false;
                }
            }
        }

        function setConnectedState(connected) {
            isConnected = connected;
            updateUI();
        }

        async function pasteFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                remoteSdpBox.value = text;
                updateUI();
                log("Pasted from clipboard.");
                if (remoteSdpBox.value === localSdpBox.value && localSdpBox.value.length > 0) {
                     log("Error: You pasted your own code!", 'system');
                     remoteSdpBox.value = '';
                     updateUI();
                }
            } catch (err) {
                log("Error: Browser blocked clipboard. Use Ctrl+V.");
            }
        }

        function copyToClipboard() {
            localSdpBox.select();
            document.execCommand("copy");
            log("Copied to clipboard.");
        }

        function clearLocalCode() {
            localSdpBox.value = '';
            updateUI();
        }

        function clearRemoteCode() {
            remoteSdpBox.value = '';
            lastProcessedRemoteCode = '';
            updateUI();
        }

        function sendMessage() {
            const text = chatInput.value;
            if (text && dataChannel && dataChannel.readyState === 'open') {
                dataChannel.send(text);
                log(text, 'me');
                chatInput.value = '';
            }
        }
        function handleEnter(e) { if (e.key === 'Enter') sendMessage(); }

        startCamera();
    </script>

</body>
</html>